---

- name: platform dependent vars
  include_vars: "{{ item }}"
  loop: "{{ query('first_found', params, errors='ignore') }}"
  vars:
    params:
      files:
        - "{{ ansible_distribution }}-{{ ansible_distribution_release }}.yml"
        - "{{ ansible_distribution }}.yml"
        - "{{ ansible_os_family }}.yml"
        - "{{ ansible_system }}.yml"
      paths:
        - '{{ role_path }}/vars/platform'
  tags: always

- name: cuda | establish pre-requisites
  package:
    name: gpg-agent
    state: present
  tags: install

- when: not install_cuda | bool
  block:
    - name: nvidia graphics card repo
      when:
        - ansible_pkg_mgr == 'apt'
        - not driver['cuda_compatible'] | bool
        - not install_cuda | bool
      apt_repository:
        repo: ppa:graphics-drivers/ppa
        state: present
        filename: nvidia-graphics
      tags: install

- include_tasks: cuda.yml
  when: install_cuda | bool or driver['cuda_compatible'] | bool
  vars:
    distro: "{{ ansible_distribution | lower }}{{ ansible_distribution_version | replace('.','') }}"

- name: nvidia driver
  when: not install_cuda | bool
  package:
    name: nvidia-driver-{{ driver['version'] }}
    state: present
  tags: install
